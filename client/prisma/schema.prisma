generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String        @unique
  passwordHash  String?       @map("password_hash")
  name          String?
  phone         String?
  emailVerified DateTime?     @map("email_verified")
  image         String?
  deletedAt     DateTime?     @map("deleted_at") @db.Timestamptz(6)
  createdAt     DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime      @default(now()) @map("updated_at") @db.Timestamptz(6)
  accounts      Account[]
  properties    Property[]
  sessions      Session[]
  transactions  Transaction[]
  monthlyMetrics MonthlyMetrics[]
  userSettings  UserSettings?
  subscription  Subscription?

  @@index([deletedAt])
  @@map("users")
}

model Property {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  address       String
  city          String?
  state         String?
  zipCode       String?         @map("zip_code")
  country       String?
  purchasePrice Decimal?        @map("purchase_price") @db.Decimal(12, 2)
  marketValue   Decimal?        @map("market_value") @db.Decimal(12, 2)
  isActive      Boolean         @default(true) @map("is_active")
  deletedAt     DateTime?       @map("deleted_at") @db.Timestamptz(6)
  createdAt     DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime        @default(now()) @map("updated_at") @db.Timestamptz(6)
  userId        String          @map("user_id") @db.Uuid
  rent          Decimal         @default(0) @db.Decimal(12, 2)
  tenants       Int             @default(0)
  type          PropertyType    @default(APARTMENT)
  occupancy     OccupancyStatus @default(AVAILABLE)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]
  monthlyMetrics MonthlyMetrics[]
  images        PropertyImage[]

  @@index([userId])
  @@index([isActive])
  @@index([deletedAt])
  @@index([occupancy])
  @@index([userId, occupancy])
  @@map("properties")
}

model PropertyImage {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId String    @map("property_id") @db.Uuid
  filename   String
  url        String
  isCover    Boolean   @default(false) @map("is_cover")
  sortOrder  Int       @default(0) @map("sort_order")
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @default(now()) @map("updated_at") @db.Timestamptz(6)
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([propertyId, isCover])
  @@index([deletedAt])
  @@map("property_images")
}

model Category {
  id           String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String          @unique
  type         TransactionType
  description  String?
  isActive     Boolean         @default(true) @map("is_active")
  createdAt    DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime        @default(now()) @map("updated_at") @db.Timestamptz(6)
  transactions Transaction[]

  @@index([type])
  @@index([isActive])
  @@map("categories")
}

model Transaction {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  amount          Decimal         @db.Decimal(12, 2)
  type            TransactionType
  description     String?
  transactionDate DateTime        @map("transaction_date") @db.Date
  isRecurring     Boolean         @default(false) @map("is_recurring")
  deletedAt       DateTime?       @map("deleted_at") @db.Timestamptz(6)
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime        @default(now()) @map("updated_at") @db.Timestamptz(6)
  userId          String          @map("user_id") @db.Uuid
  propertyId      String          @map("property_id") @db.Uuid
  categoryId      String          @map("category_id") @db.Uuid
  category        Category        @relation(fields: [categoryId], references: [id])
  property        Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, propertyId])
  @@index([userId, type])
  @@index([deletedAt])
  @@index([transactionDate])
  @@index([propertyId, type])
  @@index([categoryId])
  @@index([userId, transactionDate])
  @@index([propertyId, transactionDate])
  @@map("transactions")
}


model MonthlyMetrics {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId       String   @map("property_id") @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  year             Int
  month            Int      // 1-12
  totalIncome      Decimal  @default(0) @map("total_income") @db.Decimal(12, 2)
  totalExpenses    Decimal  @default(0) @map("total_expenses") @db.Decimal(12, 2)
  cashFlow        Decimal  @default(0) @map("cash_flow") @db.Decimal(12, 2)
  transactionCount Int      @default(0) @map("transaction_count")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)
  property         Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, year, month])
  @@index([propertyId])
  @@index([userId])
  @@index([year, month])
  @@map("monthly_metrics")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id") @db.Uuid
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Currency {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String         @unique // ISO 4217 (e.g., 'USD', 'EUR')
  symbol       String         // e.g., '$', '€', '£'
  name         String         // e.g., 'US Dollar', 'Euro'
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime       @default(now()) @map("updated_at") @db.Timestamptz(6)
  userSettings UserSettings[]

  @@index([isActive])
  @@map("currencies")
}

model Timezone {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  iana         String         @unique // IANA timezone (e.g., 'America/New_York')
  label        String         // Human-readable label (e.g., 'Eastern Time (ET)')
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime       @default(now()) @map("updated_at") @db.Timestamptz(6)
  userSettings UserSettings[]

  @@index([isActive])
  @@map("timezones")
}

model UserSettings {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                 String   @unique @map("user_id") @db.Uuid
  currencyId             String   @map("currency_id") @db.Uuid
  timezoneId             String   @map("timezone_id") @db.Uuid
  hasCompletedOnboarding Boolean  @default(false) @map("has_completed_onboarding")
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currency Currency @relation(fields: [currencyId], references: [id])
  timezone Timezone @relation(fields: [timezoneId], references: [id])

  @@index([userId])
  @@map("user_settings")
}

model Subscription {
  id                       String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                   String             @unique @map("user_id") @db.Uuid
  stripeCustomerId         String?            @map("stripe_customer_id")
  stripeSubscriptionId     String?            @map("stripe_subscription_id")
  stripeSubscriptionItemId String?            @map("stripe_subscription_item_id")
  status                   SubscriptionStatus @default(TRIAL)
  plan                     SubscriptionPlan   @default(BUSINESS)
  propertyLimit            Int                @default(999) @map("property_limit")
  trialEndsAt              DateTime?          @map("trial_ends_at") @db.Timestamptz(6)
  currentPeriodStart       DateTime?          @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd         DateTime?          @map("current_period_end") @db.Timestamptz(6)
  cancelAtPeriodEnd        Boolean            @default(false) @map("cancel_at_period_end")
  scheduledPlan            SubscriptionPlan?  @map("scheduled_plan")
  scheduledPlanDate        DateTime?          @map("scheduled_plan_date") @db.Timestamptz(6)
  createdAt                DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime           @default(now()) @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum PropertyType {
  APARTMENT
  HOUSE
  STUDIO
  TOWNHOUSE
  VILLA
  COMMERCIAL
  OFFICE
  RETAIL
  WAREHOUSE
  MIXED_USE
  OTHER
}

enum OccupancyStatus {
  AVAILABLE
  OCCUPIED
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

enum SubscriptionPlan {
  STARTER
  PRO
  BUSINESS
}
